# 새로운 법인 환경 생성 가이드

## 🎯 개요

이 가이드는 새로운 법인의 회계 관리 시스템을 **완전 자동으로** 생성하는 방법을 설명합니다.

## 📋 전체 프로세스

```
1. Apps Script 함수 생성 (1회만)
   ↓
2. 자동화 스크립트 실행
   ↓
3. Google Drive에서 환경 생성
   ↓
4. 로컬 설정 파일 자동 생성
   ↓
5. 코드 자동 배포
   ↓
6. 완료! ✅
```

## 🚀 빠른 시작

### 1단계: Apps Script 함수 추가 (최초 1회만)

**법인재무관리_유니스** 스프레드시트에서:

1. 확장 프로그램 > Apps Script
2. 파일 추가: `src/새로운환경생성.js` (또는 기존 파일에 추가)
3. 다음 코드 붙여넣기:

```javascript
/**
 * 새로운 법인 환경 완전 자동 생성 함수
 * 사용법: create환경이름완전자동() 형식으로 함수 이름 수정 후 실행
 */

const SOURCE_ID = '1RFpK_S04ZSIOPxhmpjhJjKZuQlBDFhmTQ5gwJpjYJG8'; // 유니스

function create새법인완전자동() {
  // 여기에 법인 이름을 입력하세요
  const 법인이름 = '새법인';

  return createNewEnvironment(법인이름);
}

// 실제 환경 생성 함수
function createNewEnvironment(companyName) {
  Logger.log(`🚀 ${companyName} 환경 완전 자동 생성 시작\n`);
  Logger.log('=' .repeat(70));

  try {
    // Step 1: 폴더 구조 생성
    Logger.log('📁 Step 1: 폴더 구조 생성');

    const myDrive = DriveApp.getRootFolder();
    let 법인관리 = getFolderByName(myDrive, '법인관리') || myDrive.createFolder('법인관리');
    let 재무관리 = getFolderByName(법인관리, '재무관리') || 법인관리.createFolder('재무관리');
    let 법인폴더 = getFolderByName(재무관리, companyName) || 재무관리.createFolder(companyName);
    let 은행거래내역 = getFolderByName(법인폴더, '은행거래내역') || 법인폴더.createFolder('은행거래내역');

    const folderId = 은행거래내역.getId();
    Logger.log(`✅ 폴더 구조 생성 완료`);
    Logger.log(`   은행거래내역 폴더 ID: ${folderId}\n`);

    // Step 2: 스프레드시트 생성
    Logger.log('📊 Step 2: 스프레드시트 생성');

    const spreadsheetName = `법인재무관리_${companyName}`;
    let spreadsheet = getSpreadsheetByName(법인폴더, spreadsheetName);

    if (!spreadsheet) {
      spreadsheet = SpreadsheetApp.create(spreadsheetName);
      const file = DriveApp.getFileById(spreadsheet.getId());
      file.moveTo(법인폴더);
      Logger.log(`✅ "${spreadsheetName}" 생성 완료`);
    } else {
      Logger.log(`✓ "${spreadsheetName}" 이미 존재`);
    }

    const spreadsheetId = spreadsheet.getId();
    const spreadsheetUrl = spreadsheet.getUrl();

    Logger.log(`   스프레드시트 ID: ${spreadsheetId}`);
    Logger.log(`   URL: ${spreadsheetUrl}\n`);

    // Step 3: 소스에서 모든 시트 목록 가져오기
    Logger.log('📋 Step 3: 소스 스프레드시트에서 시트 목록 가져오기');

    const sourceSpreadsheet = SpreadsheetApp.openById(SOURCE_ID);
    const sourceSheets = sourceSpreadsheet.getSheets();

    Logger.log(`   소스 시트 개수: ${sourceSheets.length}개\n`);

    // Step 4: 모든 시트 생성 및 1행 복사
    Logger.log('🔄 Step 4: 모든 시트 생성 및 1행 복사 시작');
    Logger.log('   (이 작업은 몇 분 정도 걸립니다...)\n');

    let successCount = 0;
    let skipCount = 0;
    let failCount = 0;

    sourceSheets.forEach((sourceSheet, index) => {
      const sheetName = sourceSheet.getName();

      try {
        Logger.log(`[${index + 1}/${sourceSheets.length}] ${sheetName}`);

        const lastColumn = sourceSheet.getLastColumn();
        const lastRow = sourceSheet.getLastRow();

        if (lastColumn === 0 || lastRow === 0) {
          Logger.log(`  ⊘ 빈 시트, 건너뜀`);
          skipCount++;
          return;
        }

        let targetSheet = spreadsheet.getSheetByName(sheetName);

        if (!targetSheet) {
          targetSheet = spreadsheet.insertSheet(sheetName);
          Logger.log(`  ✅ 시트 생성`);
          Utilities.sleep(300);
        }

        // 1행 데이터 및 서식 복사
        const row1Range = sourceSheet.getRange(1, 1, 1, lastColumn);
        const row1Values = row1Range.getValues();
        const row1Formats = row1Range.getNumberFormats();
        const row1FontWeights = row1Range.getFontWeights();
        const row1FontColors = row1Range.getFontColors();
        const row1Backgrounds = row1Range.getBackgrounds();
        const row1HorizontalAlignments = row1Range.getHorizontalAlignments();

        const targetRange = targetSheet.getRange(1, 1, 1, lastColumn);
        targetRange.setValues(row1Values);
        targetRange.setNumberFormats(row1Formats);
        targetRange.setFontWeights(row1FontWeights);
        targetRange.setFontColors(row1FontColors);
        targetRange.setBackgrounds(row1Backgrounds);
        targetRange.setHorizontalAlignments(row1HorizontalAlignments);

        Logger.log(`  ✅ 1행 복사 완료 (${lastColumn}개 열)`);
        successCount++;

        Utilities.sleep(200);

      } catch (error) {
        Logger.log(`  ❌ 오류: ${error.message}`);
        failCount++;
      }
    });

    // 기본 시트 삭제
    try {
      const defaultSheet = spreadsheet.getSheetByName('Sheet1');
      if (defaultSheet && spreadsheet.getSheets().length > 1) {
        spreadsheet.deleteSheet(defaultSheet);
        Logger.log('\n🗑️  기본 Sheet1 삭제');
      }
    } catch (e) {
      // 무시
    }

    // 결과 요약
    Logger.log('');
    Logger.log('=' .repeat(70));
    Logger.log(`✅ ${companyName} 환경 생성 완료!`);
    Logger.log('=' .repeat(70));
    Logger.log('');
    Logger.log('📊 작업 결과:');
    Logger.log(`   총 시트: ${sourceSheets.length}개`);
    Logger.log(`   ✅ 성공: ${successCount}개`);
    Logger.log(`   ⊘ 건너뜀: ${skipCount}개`);
    Logger.log(`   ❌ 실패: ${failCount}개`);
    Logger.log('');
    Logger.log('📋 생성된 환경 정보:');
    Logger.log(`   환경 이름: ${companyName}`);
    Logger.log(`   스프레드시트 ID: ${spreadsheetId}`);
    Logger.log(`   은행거래내역 폴더 ID: ${folderId}`);
    Logger.log(`   스프레드시트 URL: ${spreadsheetUrl}`);
    Logger.log('');
    Logger.log('📝 다음 단계:');
    Logger.log('   1. 생성된 스프레드시트 열기');
    Logger.log('   2. 확장 프로그램 > Apps Script');
    Logger.log('   3. 설정 ⚙️ > 프로젝트 설정 > 스크립트 ID 복사');
    Logger.log('   4. Claude Code 자동화 스크립트 실행');
    Logger.log('');
    Logger.log('--- 복사해서 전달할 정보 ---');
    Logger.log(`scriptId: [Apps Script 프로젝트 ID]`);
    Logger.log(`spreadsheetId: ${spreadsheetId}`);
    Logger.log(`folderId: ${folderId}`);
    Logger.log(`spreadsheetUrl: ${spreadsheetUrl}`);
    Logger.log('----------------------------');
    Logger.log('');

    return {
      success: true,
      spreadsheetId: spreadsheetId,
      folderId: folderId,
      spreadsheetUrl: spreadsheetUrl,
      stats: {
        total: sourceSheets.length,
        success: successCount,
        skipped: skipCount,
        failed: failCount
      }
    };

  } catch (error) {
    Logger.log('');
    Logger.log('❌ 오류 발생: ' + error.message);
    Logger.log(error.stack);

    return {
      success: false,
      error: error.message
    };
  }
}

// 헬퍼 함수들
function getFolderByName(parentFolder, folderName) {
  const folders = parentFolder.getFoldersByName(folderName);
  return folders.hasNext() ? folders.next() : null;
}

function getSpreadsheetByName(folder, name) {
  const files = folder.getFilesByName(name);
  if (files.hasNext()) {
    const file = files.next();
    try {
      return SpreadsheetApp.openById(file.getId());
    } catch (e) {
      return null;
    }
  }
  return null;
}
```

### 2단계: 자동화 스크립트 실행

터미널에서 다음 명령어를 실행:

```bash
cd actauto
node scripts/create-new-environment.js
```

### 3단계: 대화형 입력

스크립트가 다음 정보를 물어봅니다:

```
환경 키 (예: abc, xyz): abc
법인 이름 (예: 에이비씨): 에이비씨
설명 (선택): 에이비씨 회계 관리 시스템
```

### 4단계: Google Apps Script 실행

스크립트 안내에 따라:

1. 법인재무관리_유니스 열기
2. 확장 프로그램 > Apps Script
3. 함수 실행: `create에이비씨완전자동()`
4. 로그에서 정보 복사

### 5단계: 정보 입력 및 배포

복사한 정보를 스크립트에 입력:

```
scriptId: [복사한 ID]
spreadsheetId: [복사한 ID]
folderId: [복사한 ID]
spreadsheetUrl: [복사한 URL]

지금 바로 코드를 배포하시겠습니까? (y/n): y
```

### 6단계: 완료! ✅

자동으로 다음이 생성됩니다:

- ✅ Google Drive 폴더 구조
- ✅ 스프레드시트 + 모든 시트
- ✅ `configs/clasp-abc.json`
- ✅ `configs/environments.json` 업데이트
- ✅ 코드 배포 완료

## 📝 사용 예시

### 예시 1: 에이비씨 회사 추가

```bash
$ node scripts/create-new-environment.js

환경 키: abc
법인 이름: 에이비씨
설명: 에이비씨 회계 관리 시스템

# Google Apps Script에서 create에이비씨완전자동() 실행

scriptId: 1ABC...
spreadsheetId: 1DEF...
folderId: 1GHI...
spreadsheetUrl: https://docs.google.com/...

지금 바로 배포? y

✅ 완료!
```

### 예시 2: 엑스와이지 회사 추가

```bash
$ node scripts/create-new-environment.js

환경 키: xyz
법인 이름: 엑스와이지
설명: 엑스와이지 회계 관리 시스템

# 동일한 프로세스...

✅ 완료!
```

## 🎯 생성 후 확인사항

### 1. 스프레드시트 확인

생성된 스프레드시트를 열고:

- [ ] 모든 시트가 생성되었는지 확인
- [ ] 1행 헤더가 복사되었는지 확인
- [ ] 메뉴가 나타나는지 확인 (새로고침 필요)
  - 재무자료 관리
  - 도구 관리
  - 급여 관리

### 2. 로컬 파일 확인

```bash
# 설정 파일 확인
ls configs/clasp-abc.json
cat configs/environments.json | grep abc

# 환경 목록 확인
node scripts/deploy.js --list
```

### 3. 배포 테스트

```bash
# 특정 환경에 재배포
node scripts/deploy.js abc

# 모든 환경에 배포
node scripts/deploy.js all
```

## 🔧 트러블슈팅

### 문제: "환경 키는 영문 소문자와 숫자만 사용 가능합니다"

**해결**: 환경 키에 대문자, 특수문자, 한글 사용 불가
```
❌ ABC, a-b-c, 에이비씨
✅ abc, abc123, smartbiz
```

### 문제: "scriptId를 입력해주세요"

**해결**: Google Apps Script에서 정보를 정확히 복사했는지 확인
```
1. 스프레드시트 > 확장 프로그램 > Apps Script
2. 설정 ⚙️ > 프로젝트 설정
3. 스크립트 ID 복사
```

### 문제: 배포 실패

**해결**: 수동 배포 시도
```bash
# 1. clasp 설정 복사
cp configs/clasp-abc.json .clasp.json

# 2. 강제 푸시
npx clasp push --force
```

### 문제: 메뉴가 나타나지 않음

**해결**:
1. 스프레드시트 새로고침 (F5)
2. 몇 초 기다리기 (onOpen 함수 실행 대기)
3. 스프레드시트 완전히 닫고 다시 열기

## 📚 관련 파일

```
actauto/
├── scripts/
│   ├── create-new-environment.js    # 자동화 스크립트
│   ├── deploy.js                    # 배포 스크립트
│   └── 새로운환경생성가이드.md        # 이 파일
├── configs/
│   ├── clasp-production.json        # 유니스
│   ├── clasp-smartbiz.json         # 스마트비즈센터
│   ├── clasp-abc.json              # 새로 생성
│   └── environments.json            # 전체 환경 목록
└── src/
    ├── menu/01. 메뉴.js            # 메뉴 정의
    ├── accounting/                  # 회계 로직
    ├── bank/                        # 은행 업로드
    └── ...                          # 기타 모듈
```

## ✨ 추가 기능

### 환경 목록 보기

```bash
node scripts/deploy.js --list
```

### 특정 환경에만 배포

```bash
node scripts/deploy.js abc
```

### 모든 환경에 배포

```bash
node scripts/deploy.js all
```

## 🎓 정리

이제 새로운 법인 환경을 추가할 때:

1. ✅ 한 번의 스크립트 실행
2. ✅ Google Apps Script에서 함수 실행
3. ✅ 정보 입력 및 자동 배포
4. ✅ 완료!

**총 소요 시간**: 약 5-10분 (대부분 자동)

기존 방식 (수동):
- ❌ 폴더 수동 생성
- ❌ 스프레드시트 수동 생성
- ❌ 시트 하나씩 복사
- ❌ 설정 파일 수동 작성
- ❌ 환경 정보 수동 추가
- ❌ 수동 배포

새 방식 (자동):
- ✅ 하나의 명령어로 모든 것 자동화!

---

**작성일**: 2025-10-08
**버전**: 1.0.0
**문의**: actauto 프로젝트 관리자
